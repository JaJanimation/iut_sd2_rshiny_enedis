# Installation des packages
# install.packages("shiny")
# install.packages("DT")
# install.packages("ggplot2")
# install.packages("units", type = "binary")
# install.packages("sf", type = "binary")
# install.packages("leaflet", type = "binary")
# install.packages("bslib")
# install.packages("thematic")
# install.packages("units", type = "source")
# install.packages("sf", type = "source")
# install.packages("rsconnect")
# install.packages("jsonlite")
# install.packages("httr")

# Accès aux librairies
library(shiny)
library(DT)
library(ggplot2)
library(leaflet)
library(thematic)
library(httr)
library(jsonlite)
library(rsconnect)
library(sf)

# Chargement des données
# Existants
url1 <- "https://data.ademe.fr/data-fair/api/v1/datasets/dpe03existant/lines?page=1&size=1000&q=code_insee%3A69"
res1 <- GET(url1)
data1 <- fromJSON(content(res1, "text"), flatten = TRUE)

df1 <- data1$results

# Sélectionne uniquement les colonnes utiles
data_existant <- df1[, c(
  "type_energie_n1",
  "surface_habitable_logement",
  "typologie_logement",
  "etiquette_dpe",
  "conso_5_usages_ef",
  "conso_5_usages_par_m2_ef",
  "coordonnee_cartographique_x_ban",
  "coordonnee_cartographique_y_ban"
)]

#View(data_existant)

# Neuf
url2 <- "https://data.ademe.fr/data-fair/api/v1/datasets/dpe02neuf/lines?page=1&size=1000&q=code_insee%3A69"
res2 <- GET(url2)
data2 <- fromJSON(content(res2, "text"), flatten = TRUE)

df2 <- data2$results

# Sélectionne uniquement les colonnes utiles
data_neuf <- df2[, c(
  "type_energie_n1",
  "surface_habitable_logement",
  "typologie_logement",
  "etiquette_dpe",
  "conso_5_usages_ef",
  "conso_5_usages_par_m2_ef",
  "coordonnee_cartographique_x_ban",
  "coordonnee_cartographique_y_ban"
)]

#View(data_neuf)

# Combinaison des data frames
data_neuf$source <- "Neuf"
data_existant$source <- "Existant"
data_all <- rbind(data_neuf, data_existant)
data_all <- subset(data_all,
                   !is.na(coordonnee_cartographique_x_ban) &
                     !is.na(coordonnee_cartographique_y_ban))

#View(data_all)

# Conversion des coordonnées Lambert 93 en WGS84 pour les markers sur la carte
data_all_sf <- st_as_sf(data_all, coords = c("coordonnee_cartographique_x_ban", "coordonnee_cartographique_y_ban"), crs = 2154)
data_all_sf <- st_transform(data_all_sf, crs = 4326)

# Extraction des coordonnées converties
coords <- st_coordinates(data_all_sf)
data_all$lon <- coords[, 1]
data_all$lat <- coords[, 2]

# Initialisation du logo pour la mise en page de l'application
logo_ui <- tags$div(
  style = "position: absolute; top: 10px; right: 10px; z-index: 1000;",
  tags$img(src = "https://raw.githubusercontent.com/JaJanimation/iut_sd2_rshiny_enedis/main/enedis_logo.png", height = "50px")
)

# Interface
ui <- navbarPage(
  title = div("Consommation énergétique et DPE", logo_ui),
  
  # Onglet 'Contexte' contenant les informations et statistiques sur les données
  tabPanel(tagList(icon("info-circle"), "Contexte"),
           fluidPage(
             h2("Contexte de l'application"),
             p("Enedis souhaite évaluer l'impact de la classe DPE sur la consommation des logements."),
             h3("Données disponibles"),
             # Création de filtre (ici sous forme de menu déroulant)
             # Filtre sur le type de logement (Existant ou Neuf)
             selectInput("filtre_source", "Filtrer par source :", choices = c("Tous", "Neuf", "Existant")),
             selectInput("filtre_energie", "Filtrer par énergie :", choices = c("Tous", sort(unique(data_all$type_energie_n1)))),
             selectInput("filtre_dpe", "Filtrer par classe DPE :", choices = c("Tous", sort(unique(data_all$etiquette_dpe)))),
             # Mise en place des emplacements où les tableaux de statistiques seront affichées
             DT::dataTableOutput("table_apercu"),
             # Bouton de téléchargement des tableaux de données
             downloadButton("export_csv", "Télécharger les données filtrées"),
             h3("Statistiques"),
             verbatimTextOutput("stats_resume"),
             h3("Indicateurs clés sur la consommation énergétique"),
             textOutput("kpi_logements"),
             textOutput("kpi_conso_totale"),
             textOutput("kpi_conso_m2"),
             verbatimTextOutput("kpi_source"),
             verbatimTextOutput("kpi_dpe"),
             h3("Répartition des classes DPE"),
             plotOutput("hist_dpe"),
             # Bouton de téléchargement de l'histogramme
             downloadButton("export_hist_contexte", "Télécharger le graphique")
           )
  ),
  
  # Onglet 'Analyse et Visualisation' contenant la majorité des graphiques 
  #(les graphiques sont ajustés selon les filtres sélectionnés)
  tabPanel(tagList(icon("chart-bar"), "Analyse et Visualisation"),
           sidebarLayout(
             # Panneau avec les filtres
             sidebarPanel(
               # Création de filtres (ici sous forme de case à cocher)
               # Filtre sur le type de logement (Existant ou Neuf)
               checkboxGroupInput("source_dpe", "Source DPE :", choices = c("Neuf", "Existant"), selected = c("Neuf", "Existant")),
               # Filtre sur le type d'énergie principalement utilisé par les logements
               checkboxGroupInput("energie", "Type d'énergie :", choices = NULL),
               # Slider permettant de choisir la surface habitable minimum et maximum 
               # Permet d'éliminer les extremums
               sliderInput("surface", "Surface habitable (m²) :", min = 0, max = 300, value = c(0, 300)),
               # Texte explicatif sur l'utilité du slider pour l'utilisateur
               helpText("Ce filtre permet de sélectionner uniquement les logements 
                 dont la surface habitable est comprise entre les deux valeurs 
                 choisies. Cela permet d'exclure les logements trop petits ou trop grands pour une analyse plus ciblée."),
               # Bouton permettant de réinitialiser les filtres
               actionButton("reset", "Réinitialiser les filtres")
             ),
             # Panneau avec les graphiques
             mainPanel(
               # Création de la boîte à moustache
               h3("Boîte à moustaches : consommation par m²"),
               plotOutput("plot_boite"),
               # Bouton de téléchargement du graphique
               downloadButton("export_boite", "Télécharger le graphique"),
               
               # Création du diagramme en bâton
               h3("Diagramme des types d'énergie"),
               plotOutput("plot_diagramme"),
               # Bouton de téléchargement du graphique
               downloadButton("export_diagramme", "Télécharger le graphique"),
               
               # Création du nuage de point
               h3("Nuage de points : surface vs consommation"),
               plotOutput("plot_nuage"),
               # Bouton de téléchargement du graphique
               downloadButton("export_nuage", "Télécharger le graphique")
             )
           )
  ),
  
  # Onglet "Cartographie" (fait avec leaflet)
  tabPanel(tagList(icon("map"), "Cartographie"),
           fluidPage(
             h2("Carte interactive des logements"),
             p("Chaque point représente un logement, coloré selon sa classe DPE."),
             leafletOutput("map_dpe", height = "600px")
           )
  )
)

# Exécution de l'application
server <- function(input, output, session) {
  
  # Onglet 'Contexte'
  # Activation des filtres dynamiques sur le type d'énergie
  observe({
    updateCheckboxGroupInput(session, "energie", choices = unique(data_all$type_energie_n1), selected = unique(data_all$type_energie_n1))
  })
  
  data_contexte <- reactive({
    df <- data_all

    if (!is.null(input$filtre_source) && input$filtre_source != "Tous") {
      df <- df[df$source == input$filtre_source, ]
    }
    if (!is.null(input$filtre_energie) && input$filtre_energie != "Tous") {
      df <- df[df$type_energie_n1 == input$filtre_energie, ]
    }
    if (!is.null(input$filtre_dpe) && input$filtre_dpe != "Tous") {
      df <- df[df$etiquette_dpe == input$filtre_dpe, ]
    }

    df
  })
  
  # Tableau de donnée 
  output$table_apercu <- DT::renderDataTable({
  #Affiche toutes les données de base
    df <- data_contexte()
    
    # Renommage des colonnes du tableau pour qu'elles soient plus explicitent
    # lors de l'affichage
    df <- df[, c(
      "type_energie_n1",
      "surface_habitable_logement",
      "typologie_logement",
      "etiquette_dpe",
      "conso_5_usages_ef",
      "conso_5_usages_par_m2_ef",
      "coordonnee_cartographique_x_ban",
      "coordonnee_cartographique_y_ban",
      "source"
    )]
    
    colnames(df) <- c(
      "Type d'énergie",
      "Surface habitable (m²)",
      "Typologie du logement",
      "Classe DPE",
      "Consommation totale (kWh)",
      "Consommation par m² (kWh/m²)",
      "Coordonnée X",
      "Coordonnée Y",
      "Source"
    )
    
    datatable(df)
  })
  
  # Activation du bouton de téléchargement des données
  output$export_csv <- downloadHandler(
    filename = function() {"donnees_filtrees.csv"},
    content = function(file) {
      write.csv(data_filtrée(), file, row.names = FALSE)
    }
  )
  
  # Activation de l'affichage des statistiques 
  # (concerne la consommation énergétique totale pour les 5 usages par logements)
  # 5 usages : Cuisson, Chauffage, Éclairage, Électricité spécifique (appareils),Eau chaude
  output$stats_resume <- renderPrint({
    x <- data_contexte()$conso_5_usages_ef
    stats <- summary(x)
    # cat --> concaténation, permet de séparer les données du summary pour les mettres en forme de façon plus propre
    # \n --> permet un retour à la ligne
    cat("Statistiques sur la consommation énergétique totale (conso_5_usages_ef) :\n\n")
    cat("Minimum :", stats["Min."], "kWh\n")
    cat("1er quartile (25%) :", stats["1st Qu."], "kWh\n")
    cat("Médiane (50%) :", stats["Median"], "kWh\n")
    cat("Moyenne :", round(stats["Mean"], 2), "kWh\n")
    cat("3e quartile (75%) :", stats["3rd Qu."], "kWh\n")
    cat("Maximum :", stats["Max."], "kWh\n")
  })
  
  # Activation des KPI sur les données
  output$kpi_logements <- renderText({
    paste("Nombre de logements :", nrow(data_contexte()))
  })
  
  output$kpi_conso_totale <- renderText({
    paste("Consommation totale (kWh) :", round(sum(data_contexte()$conso_5_usages_ef, na.rm = TRUE)))
  })
  
  output$kpi_conso_m2 <- renderText({
    paste("Consommation moyenne par m² :", round(mean(data_contexte()$conso_5_usages_par_m2_ef, na.rm = TRUE), 2))
  })
  
  output$kpi_source <- renderPrint({
    tab <- table(data_contexte()$source)
    cat("Répartition des logements par source :\n\n")
    for (i in names(tab)) {
      cat("- ", i, ":", tab[[i]], "logements\n")
    }
  })
  
  output$kpi_dpe <- renderPrint({
    tab <- table(data_contexte()$etiquette_dpe)
    cat("Répartition des logements par classe DPE :\n\n")
    for (i in names(tab)) {
      cat("- Classe", i, ":", tab[[i]], "logements\n")
    }
  })
  
  # Activation de l'histogramme
  output$hist_dpe <- renderPlot({
    df <- data_all
    
    # Applique les filtres sur l'e graphique'histogramme (le graphique s'adapte dynamiquement)
    if (!is.null(input$filtre_source) && input$filtre_source != "Tous") {
      df <- df[df$source == input$filtre_source, ]
    }
    if (!is.null(input$filtre_energie) && input$filtre_energie != "Tous") {
      df <- df[df$type_energie_n1 == input$filtre_energie, ]
    }
    if (!is.null(input$filtre_dpe) && input$filtre_dpe != "Tous") {
      df <- df[df$etiquette_dpe == input$filtre_dpe, ]
    }
    
    # Le titre s'adapte également selon la source sélectionnée
    titre <- switch(input$filtre_source,
                    "Neuf" = "Répartition des classes DPE (Logements neufs)",
                    "Existant" = "Répartition des classes DPE (Logements existants)",
                    "Tous" = "Répartition des classes DPE (Tous les logements)")
    
    ggplot(df, aes(x = etiquette_dpe)) +
      geom_bar(fill = "steelblue") +
      theme_minimal() +
      labs(x = "Classe DPE", y = "Nombre de logements", title = titre)
  })
  
  # Activation du bouton de téléchargement de l'histogramme
  output$export_hist_contexte <- downloadHandler(
    filename = function() {"repartition_dpe.png"},
    content = function(file) {
      
      # Permet d'adapter le graphique selon les filtres lors du téléchargement en png
      # Sans ça, il veut s'enregistrer en HTML
      df <- data_all

      if (!is.null(input$filtre_source) && input$filtre_source != "Tous") {
        df <- df[df$source == input$filtre_source, ]
      }
      if (!is.null(input$filtre_energie) && input$filtre_energie != "Tous") {
        df <- df[df$type_energie_n1 == input$filtre_energie, ]
      }
      if (!is.null(input$filtre_dpe) && input$filtre_dpe != "Tous") {
        df <- df[df$etiquette_dpe == input$filtre_dpe, ]
      }

      titre <- switch(input$filtre_source,
                      "Neuf" = "Répartition des classes DPE (Logements neufs)",
                      "Existant" = "Répartition des classes DPE (Logements existants)",
                      "Tous" = "Répartition des classes DPE (Tous les logements)")
      
      png(file)
      print(
        ggplot(df, aes(x = etiquette_dpe)) +
          geom_bar(fill = "steelblue") +
          theme_minimal() +
          labs(x = "Classe DPE", y = "Nombre de logements", title = titre)
      )
      # Permet de finaliser le fichier
      dev.off()
    })
  
  # Onglet 'Analyse et Visualisation'
  
  # Activation du bouton de réinitialisation des filtres ('Analyse et Visualisation')
  # Observe --> Déclenche une action si un événement se produit
  observeEvent(input$reset, {
    updateCheckboxGroupInput(session, "source_dpe", selected = c("Neuf", "Existant"))
    updateCheckboxGroupInput(session, "energie", selected = unique(data_all$type_energie_n1))
    updateSliderInput(session, "surface", value = c(0, 300))
  })
  
  # Activation du filtrage dynamique sur les graphiques ('Analyse et Visualisation')
  data_filtrée <- reactive({
    req(input$source_dpe, input$energie)
    subset(data_all,
           source %in% input$source_dpe &
             type_energie_n1 %in% input$energie &
             surface_habitable_logement >= input$surface[1] &
             surface_habitable_logement <= input$surface[2])
  })
  
  # Activation de la boîte à moustache
  output$plot_boite <- renderPlot({
    ggplot(data_filtrée(), aes(x = etiquette_dpe, y = conso_5_usages_par_m2_ef)) +
      geom_boxplot(fill = "lightgreen") +
      theme_minimal() +
      labs(x = "Classe DPE", y = "Consommation par m² (kWh/m²)", title = "Distribution de la consommation par m² selon la classe DPE")
  })
  
  # Activation du diagramme
  output$plot_diagramme <- renderPlot({
    ggplot(data_filtrée(), aes(x = type_energie_n1)) +
      geom_bar(fill = "purple") +
      theme_minimal() +
      coord_flip() +
      labs(x = "Type d'énergie", y = "Nombre de logements", title = "Répartition des types d'énergie")
  })
  
  # Activation du nuage de point
  output$plot_nuage <- renderPlot({
    ggplot(data_filtrée(), aes(x = surface_habitable_logement, y = conso_5_usages_ef)) +
      geom_point(alpha = 0.5, color = "darkblue") +
      theme_minimal() +
      labs(x = "Surface habitable (m²)", y = "Consommation totale (kWh)", title = "Surface vs Consommation énergétique")
  })
  
  # Activation du bouton de téléchargement de la boîte à moustache
  output$export_boite <- downloadHandler(
    filename = function() {"boite_conso_par_m2.png"},
    content = function(file) {
      png(file)
      print(
        ggplot(data_filtrée(), aes(x = etiquette_dpe, y = conso_5_usages_par_m2_ef)) +
          geom_boxplot(fill = "lightgreen") +
          theme_minimal() +
          labs(x = "Classe DPE", y = "Consommation par m² (kWh/m²)", title = "Distribution de la consommation par m² selon la classe DPE")
      )
      dev.off()
    })
  
  # Activation du bouton de téléchargement du diagramme
  output$export_diagramme <- downloadHandler(
    filename = function() {"diagramme_types_energie.png"},
    content = function(file) {
      png(file)
      print(
        ggplot(data_filtrée(), aes(x = type_energie_n1)) +
          geom_bar(fill = "purple") +
          theme_minimal() +
          coord_flip() +
          labs(x = "Type d'énergie", y = "Nombre de logements", title = "Répartition des types d'énergie")
      )
      dev.off()
    })
  
  # Activation du bouton de téléchargement du nuage de point
  output$export_nuage <- downloadHandler(
    filename = function() {"nuage_surface_conso.png"},
    content = function(file) {
      png(file)
      print(
        ggplot(data_filtrée(), aes(x = surface_habitable_logement, y = conso_5_usages_ef)) +
          geom_point(alpha = 0.5, color = "darkblue") +
          theme_minimal() +
          labs(x = "Surface habitable (m²)", y = "Consommation totale (kWh)", title = "Surface vs Consommation énergétique")
      )
      dev.off()
    })
  
  # Onglet 'Cartographie'
  
  # Activation de la carte
  output$map_dpe <- renderLeaflet({
    df <- data_all
    
    # Centrage sur le Rhône (Lyon)
    centre_lat <- 45.75
    centre_lng <- 4.85
    
    # Couleurs pour les classes DPE
    palette_dpe <- colorFactor(
      palette = "Set1",
      domain = df$etiquette_dpe
    )
    
    # Création des markers
    leaflet(df) %>%
      addTiles() %>%
      setView(lng = centre_lng, lat = centre_lat, zoom = 9) %>%
      addCircleMarkers(
        lng = ~lon,
        lat = ~lat,
        color = ~palette_dpe(etiquette_dpe),
        radius = 5,
        stroke = FALSE,
        fillOpacity = 0.7,
        popup = ~paste0(
          "<strong>Classe DPE :</strong> ", etiquette_dpe, "<br>",
          "<strong>Surface :</strong> ", surface_habitable_logement, " m²<br>",
          "<strong>Énergie :</strong> ", type_energie_n1
        )
      ) %>%
      
      # Légende de la carte
      addLegend(
        "bottomright",
        pal = palette_dpe,
        values = ~etiquette_dpe,
        title = "Classe DPE",
        opacity = 1
      )
  })
  
}

# Lancement de l'application
shinyApp(ui, server)
